#!/bin/bash

PATH=/usr/bin:/usr/sbin

. @RCDIR@/rc.conf
. @RCDIR@/functions
. @RCDIR@/rc.shutdown

status "Stop services ..." sv force-stop @RUNDIR@/service/*
status "Exit services ..." sv exit @RUNDIR@/service/*

if [ -e @RUNDIR@/reboot ]; then
    chmod 100 @RUNDIR@/reboot
fi

# avoid staircase effect
stty onlcr

echo " "
printhl "Initiating shutdown..."
echo " "

run_hook shutdown_start

run_hook shutdown_prekillall

run_hook shutdown_postkillall

run_hook shutdown_preumount

run_hook shutdown_postumount

run_hook shutdown_poweroff

if [ -e @RUNDIR@/reboot ]; then
    [[ -x $(type -P kexec) ]] && kexec -e &>/dev/null
fi

status "Stage 3 completed."
